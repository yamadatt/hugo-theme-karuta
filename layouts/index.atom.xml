{{- $pctx := . -}}
{{- if .IsHome -}}{{ $pctx = .Site }}{{- end -}}
{{- $pages := slice -}}
{{- if or $.IsHome $.IsSection -}}
  {{- $pages = $pctx.RegularPages -}}
{{- else -}}
  {{- $pages = $pctx.Pages -}}
{{- end -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\"?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>{{ if eq .Title .Site.Title }}{{ .Site.Title }}{{ else }}{{ with .Title }}{{ . }} - {{ end }}{{ .Site.Title }}{{ end }}</title>
  <id>{{ .Permalink }}</id>
  <link rel="alternate" type="text/html" href="{{ .Permalink }}" />
  {{- with .OutputFormats.Get "Atom" -}}
    {{ printf "<link rel=\"self\" type=%q href=%q />" .MediaType .Permalink | safeHTML }}
  {{- end }}
  {{- if not .Date.IsZero -}}
    <updated>{{ .Date.UTC.Format "2006-01-02T15:04:05Z" }}</updated>
  {{- else -}}
    {{- with (index $pages 0) -}}
      <updated>{{ .Date.UTC.Format "2006-01-02T15:04:05Z" }}</updated>
    {{- end -}}
  {{- end }}
  {{- range $pages -}}
    <entry>
      <title>{{ .Title }}</title>
      <link rel="alternate" type="text/html" href="{{ .Permalink }}" />
      <id>{{ .Permalink }}</id>
      <updated>{{ .Lastmod.UTC.Format "2006-01-02T15:04:05Z" }}</updated>
      <published>{{ .Date.UTC.Format "2006-01-02T15:04:05Z" }}</published>
      {{- with .Site.Author.name -}}
        <author>
          <name>{{ . }}</name>{{ with $.Site.Author.email }}<email>{{ . }}</email>{{ end }}
        </author>
      {{- end }}
      {{- if $.Site.Params.rss.fullText -}}
        <content type="html">{{ .Content | html }}</content>
      {{- else -}}
        <summary type="html">{{ .Summary | html }}</summary>
      {{- end }}
      {{- with .Params.tags -}}
        {{- range . -}}<category term="{{ . }}" />{{- end -}}
      {{- end -}}
    </entry>
  {{- end }}
</feed>

